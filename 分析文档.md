# 拾取筛模组 - 项目审查（漏洞/性能）与改进记录

本次文档用于承接“项目审查”的结论与修复项，便于后续迭代按优先级持续收敛风险。

## 0. 审查范围与结论

- 范围：`src/main/java`（网络包、配置、规则匹配、事件回调）、`src/test/java`（关键性质测试）
- 结论：核心逻辑整体清晰；主要风险集中在“异常静默导致的数据丢失/无可观测性”“网络 ByteBuf 解析鲁棒性”“高频 tick 扫描”三类

## 1. 安全/稳定性审查（漏洞类）

### P0 - 数据丢失风险（已修复）

**问题**：配置/设置文件读取失败时会落回默认值并立即 `save()`，可能覆盖原文件（I/O 异常、权限、损坏文件等场景）。

**修复**：

- `ConfigManager` / `CommonSettings` / `ClientSettings`：读取失败直接返回，不再覆盖写回；并记录日志（可观测）

### P0 - 网络包解析鲁棒性（已修复）

**问题**：部分 `fromBytes` 在数据不完整/被篡改时可能触发 `IndexOutOfBoundsException`，导致连接被动断开（DoS 形态）。

**修复**：

- `ConfigSnapshotPacket.readString/readClampedInt`：增加 `readableBytes` 保护与截断读取
- `UpdateConfigPacket.fromBytes` / `ConfigSnapshotPacket.readRulesList`：使用安全读取的 `readClampedInt`
- 各 `Handler`：补充 `ctx/getServerHandler` 空值保护

### P1 - 用户输入解析导致崩溃（已修复）

**问题**：`FilterRule.deserialize` 对 `@meta` 或 `:meta` 中非数字输入会抛异常，触发 GUI/逻辑调用处崩溃风险。

**修复**：

- `FilterRule.deserialize`：非法 `meta` 直接返回 `null`（上层将拒绝该规则）

## 2. 性能审查

### P1 - 高频 tick 扫描（已缓解，建议按以下方案继续优化）

**问题**：`CommonEventHandler#onLivingUpdate` 在 `DESTROY_MATCHING` 模式下每 tick 扫描附近掉落物并逐一匹配，玩家多/掉落密集时会放大服务器开销。

**缓解**：

- 增加节流：默认每 `5 tick` 执行一次扫描；且当规则为空时直接跳过扫描
- 支持配置：通过 `pickupfilter-common.properties` 提供扫描最小/最大间隔、退避阈值、单次扫描实体上限（默认保持 `5 tick` 行为不变；`max > min` 才会启用退避）
- 自适应触发（轻量）：规则更新会触发提前扫描；当启用退避时，玩家移动会恢复到最小间隔

**建议后续（需评估体验/行为变化）**：

- 进一步基于“最近一次附近有掉落物/玩家是否移动/是否刚更新规则”等条件做自适应节流
- 引入“空结果退避”：连续若干次未发现匹配/掉落物时，逐步放大扫描间隔（如 5→10→20 tick），发现后恢复
- 将扫描频率做成可配置项（区分最小/最大间隔），默认维持 5 tick，便于按服务器负载调参
- 若可接受更大改动，可改为事件驱动：监听掉落物生成/消失事件，维护玩家附近掉落物集合，tick 只处理增量
- 若继续使用全量扫描，建议限定单次扫描的实体上限/时间预算（避免密集掉落场景一次性吃满）

### P2 - 去重/contains 带来的 O(n²)（已优化）

**问题**：多处 `List.contains` 在循环内做去重（规则数上限 200 时仍可能累积）。

**优化**：

- `ConfigSnapshotPacket.parseRules` / `ClientConfigSnapshotStore.copyRules` / `UpdateConfigPacket`：使用 `LinkedHashSet` 去重保持顺序
- `FilterRulesEditor.replaceAll`：批量替换规则时先 set 去重再落表

## 3. 网络负载与协议一致性

### P1 - 字符串长度协议不一致（已修复）

**问题**：接收侧对规则字符串按 `256 bytes` 限制读取，但发送侧未限制长度；可能导致客户端/服务端之间出现“读取为空字符串/错位”的兼容问题。

**修复**：

- 网络包写入侧对 `modeId(32)`、`rule(256)` 统一做 `UTF-8 bytes` 截断写入

## 4. 仍需跟进的事项（清单）

- P2：配置同步/IO 仍为同步写（Minecraft 体系下通常可接受，但注意频繁调用）
- P2：日志目前只覆盖关键 I/O/解析失败；若后续引入更多可观测性，建议补充“网络包拒绝/截断”统计（避免刷屏）
